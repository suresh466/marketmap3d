<!-- static/index.html -->
<!DOCTYPE html>
<html>
<head>
    <title>Flea Market Map</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/cytoscape/3.26.0/cytoscape.min.js"></script>
    <style>
        #cy {
            width: 80%;
            height: 700px;
            position: absolute;
            top: 40px;
            left: 150px;
        }
        .controls {
            position: absolute;
            top: 30px;
            left: 1300px;
            z-index: 1;
            background: white;
            padding: 10px;
            border-radius: 5px;
            box-shadow: 0 0 10px rgba(0,0,0,0.1);
        }
        .highlighted {
            background-color: #ff0 !important;
            line-color: #f00 !important;
            target-arrow-color: #f00 !important;
            width: 4 !important;
        }
    </style>
</head>
<body>
    <div class="controls">
        <button id="fit">Fit View</button>
        <button id="reset">Reset View</button>
    </div>

    <div id="booths">
    </div>
    <div id="cy"></div>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // Initialize Cytoscape instance
            const cy = cytoscape({
                container: document.getElementById('cy'),
                style: [
                    {
                        selector: 'node',
                        style: {
                            'background-color': '#6C66',
                            'label': 'data(label)',
                            'text-valign': 'center',
                            'text-halign': 'center',
                            'width': 'data(width)',
                            'height': 'data(height)',
                            'shape': function(ele) {
                                return ele.data('shape_type') || 'rectangle';
                            }
                        }
                    },
                    {
                        selector: 'edge',
                        style: {
                            'width': 2,
                            'line-color': '#999',
                            'curve-style': 'bezier'
                        }
                    },
                    {
                        selector: '.highlighted',
                        style: {
                            'background-color': '#ff0',
                            'line-color': '#f00',
                            'target-arrow-color': '#f00',
                        }
                    }
                ],
                layout: {
                    name: 'preset' // Use preset layout to maintain yEd coordinates
                },
                wheelSensitivity: 0.2
            });

            // Fetch and load graph data
            fetch('/api/graph')
                .then(response => response.json())
                .then(data => {
                    cy.elements().remove(); // Clear existing elements
                    cy.add(data);
                    cy.fit();
                })
                .catch(error => console.error('Error loading graph:', error));

            // Add button event listeners
            document.getElementById('fit').addEventListener('click', () => {
                cy.fit();
            });

            document.getElementById('reset').addEventListener('click', () => {
                cy.reset();
            });


            fetch('api/booths')
                .then(response => response.json())
                .then(booths => {
                    booths_div = document.getElementById('booths')
                    ul = document.createElement('ul');

                    for (let booth of booths) {
                        li = document.createElement('li');
                        const link = document.createElement('a');
                        link.textContent = booth.label;
                        link.href = '#'; // Prevent navigation
                        link.onclick = (e) => {
                            e.preventDefault();
                            fetch(`shortest-path/n0/${booth.id}`)
                                .then(response => response.json())
                                .then(data => {
                                    highlightPath(data.path);
                                });
                        };
                        li.appendChild(link);
                        ul.appendChild(li);
                    }
                    booths_div.appendChild(ul);
                });

            // Function to highlight path
            function highlightPath(path) {
                // Reset all elements to default style
                cy.elements().removeClass('highlighted');

                for (let i = 0; i < path.length - 1; i++) {
                    // Highlight nodes and edges
                    cy.getElementById(path[i]).addClass('highlighted');
                    cy.getElementById(`edge_${path[i]}_${path[i+1]}`).addClass('highlighted');
                    // Try reverse edge if the first doesn't exist
                    if (!cy.getElementById(`edge_${path[i]}_${path[i+1]}`).length) {
                        cy.getElementById(`edge_${path[i+1]}_${path[i]}`).addClass('highlighted');
                    }
                }
                // Highlight last node
                cy.getElementById(path[path.length-1]).addClass('highlighted');
            }


        });
    </script>
</body>
</html>
